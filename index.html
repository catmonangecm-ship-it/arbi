<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Bot Arbitrage ULTRA - Plus d'Opportunit√©s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
        }
        .neon-border {
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            border: 2px solid #ff0000;
        }
        @keyframes pulse-neon {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 0, 1); }
        }
        .pulse-neon {
            animation: pulse-neon 2s ease-in-out infinite;
        }
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .gradient-animate {
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 10px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.5);
            border-radius: 10px;
        }
    </style>
</head>
<body class="text-white p-4">
    <div class="max-w-[1800px] mx-auto">
        <!-- AVERTISSEMENT CRITIQUE -->
        <div class="neon-border pulse-neon bg-red-900/30 backdrop-blur-xl rounded-3xl p-8 mb-6">
            <div class="flex items-start gap-6">
                <div class="text-6xl">‚ö†Ô∏è</div>
                <div class="flex-1">
                    <h2 class="text-3xl font-bold text-red-400 mb-4">MODE R√âEL ULTRA - TRANSACTIONS BLOCKCHAIN</h2>
                    <div class="space-y-3 text-red-200">
                        <p class="text-lg font-bold">üî¥ Ce bot ex√©cute de VRAIES transactions sur la blockchain BSC</p>
                        <p>‚úÖ Scan de 15+ tokens sur 6 DEX = 100+ paires</p>
                        <p>‚úÖ Arbitrage triangulaire (3 swaps)</p>
                        <p>‚úÖ Chaque arbitrage consomme du GAS (BNB r√©el)</p>
                        <p>‚úÖ Vous pouvez PERDRE de l'argent si le march√© bouge rapidement</p>
                        <p class="text-xl font-bold mt-4">üí∞ COMMENCEZ AVEC DE PETITS MONTANTS (0.01-0.05 BNB)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="bg-gradient-to-r from-red-500/20 via-orange-500/20 to-yellow-500/20 backdrop-blur-xl rounded-3xl p-8 mb-6 border border-red-500/30 gradient-animate">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                <div>
                    <h1 class="text-5xl font-bold mb-3 bg-gradient-to-r from-red-400 via-orange-400 to-yellow-400 bg-clip-text text-transparent">
                        üöÄ Bot Arbitrage ULTRA
                    </h1>
                    <p class="text-red-300 text-lg font-bold">
                        ‚ö° 15+ Tokens ‚Ä¢ 6 DEX ‚Ä¢ Scan Triangulaire ‚Ä¢ Plus d'Opportunit√©s
                    </p>
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="connectWallet()" id="connectBtn" class="px-10 py-5 bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 rounded-2xl font-bold text-xl shadow-2xl transition-all transform hover:scale-105">
                        <span id="walletText">üîå Connecter MetaMask</span>
                    </button>
                    <div id="walletInfo" class="hidden text-sm text-center bg-slate-900/50 rounded-xl p-3 border border-red-500/30">
                        <p><strong>Balance:</strong> <span id="bnbBalance">0</span> BNB</p>
                        <p><strong>Approvals:</strong> <span id="approvalStatus" class="text-yellow-400">En attente</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-red-500/10 backdrop-blur-xl rounded-2xl p-6 border border-red-500/30 text-center">
                <p class="text-sm text-red-400 mb-2">üî¥ Status</p>
                <p id="scanStatus" class="text-4xl font-bold">‚è∏Ô∏è</p>
            </div>
            <div class="bg-green-500/10 backdrop-blur-xl rounded-2xl p-6 border border-green-500/30 text-center">
                <p class="text-sm text-green-400 mb-2">üíé Opportunit√©s</p>
                <p id="oppCount" class="text-4xl font-bold text-green-400">0</p>
            </div>
            <div class="bg-purple-500/10 backdrop-blur-xl rounded-2xl p-6 border border-purple-500/30 text-center">
                <p class="text-sm text-purple-400 mb-2">üí∞ Profit Net</p>
                <p id="totalProfit" class="text-4xl font-bold text-purple-400">0</p>
            </div>
            <div class="bg-yellow-500/10 backdrop-blur-xl rounded-2xl p-6 border border-yellow-500/30 text-center">
                <p class="text-sm text-yellow-400 mb-2">‚õΩ Gas</p>
                <p id="gasPrice" class="text-4xl font-bold text-yellow-400">-</p>
            </div>
            <div class="bg-blue-500/10 backdrop-blur-xl rounded-2xl p-6 border border-blue-500/30 text-center">
                <p class="text-sm text-blue-400 mb-2">‚úÖ R√©ussis</p>
                <p id="successCount" class="text-4xl font-bold text-blue-400">0</p>
            </div>
            <div class="bg-red-500/10 backdrop-blur-xl rounded-2xl p-6 border border-red-500/30 text-center">
                <p class="text-sm text-red-400 mb-2">‚ùå √âchecs</p>
                <p id="failCount" class="text-4xl font-bold text-red-400">0</p>
            </div>
        </div>

        <!-- Configuration -->
        <div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-xl rounded-3xl p-8 mb-6 border border-slate-700/50">
            <h2 class="text-3xl font-bold mb-6 text-orange-400">‚öôÔ∏è Configuration Trading Ultra</h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div>
                    <label class="block text-sm mb-2 text-orange-300 font-bold">Montant par Trade (BNB)</label>
                    <input type="number" id="tradeAmount" value="0.01" min="0.001" step="0.001" class="w-full bg-slate-700/50 border border-orange-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-orange-400 text-white text-lg font-bold">
                    <p class="text-xs text-red-400 mt-1 font-bold">‚ö†Ô∏è Commence petit! 0.01-0.05 BNB recommand√©</p>
                </div>
                <div>
                    <label class="block text-sm mb-2 text-orange-300 font-bold">Profit Minimum (%)</label>
                    <input type="number" id="minProfit" value="0.3" min="0.1" step="0.1" class="w-full bg-slate-700/50 border border-orange-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-orange-400 text-white text-lg font-bold">
                    <p class="text-xs text-green-400 mt-1">‚ú® R√©duit √† 0.3% pour plus d'opportunit√©s</p>
                </div>
                <div>
                    <label class="block text-sm mb-2 text-orange-300 font-bold">Slippage Max (%)</label>
                    <input type="number" id="maxSlippage" value="1" min="0.1" step="0.1" class="w-full bg-slate-700/50 border border-orange-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-orange-400 text-white text-lg font-bold">
                    <p class="text-xs text-slate-400 mt-1">Protection contre variations de prix</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm mb-2 text-cyan-300">Max Gas (Gwei)</label>
                    <input type="number" id="maxGas" value="5" min="1" step="0.5" class="w-full bg-slate-700/50 border border-cyan-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-cyan-400 text-white">
                </div>
                <div>
                    <label class="block text-sm mb-2 text-cyan-300">Intervalle (sec)</label>
                    <input type="number" id="scanInterval" value="8" min="3" step="1" class="w-full bg-slate-700/50 border border-cyan-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-cyan-400 text-white">
                    <p class="text-xs text-green-400 mt-1">‚ú® Scan plus rapide</p>
                </div>
                <div>
                    <label class="block text-sm mb-2 text-cyan-300">Type Arbitrage</label>
                    <select id="arbType" class="w-full bg-slate-700/50 border border-cyan-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-cyan-400 text-white">
                        <option value="both">üî• Simple + Triangulaire</option>
                        <option value="simple">Simple (2 swaps)</option>
                        <option value="triangular">Triangulaire (3 swaps)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-2 text-cyan-300">Mode Ex√©cution</label>
                    <select id="executionMode" class="w-full bg-slate-700/50 border border-cyan-500/30 rounded-xl px-4 py-3 focus:outline-none focus:border-cyan-400 text-white">
                        <option value="manual">üëÅÔ∏è Manuel (S√©curis√©)</option>
                        <option value="auto">ü§ñ Automatique</option>
                    </select>
                </div>
            </div>

            <!-- Boutons -->
            <div class="flex gap-4 mb-6">
                <button onclick="approveTokens()" id="approveBtn" class="flex-1 px-8 py-5 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 rounded-2xl font-bold text-xl shadow-2xl transition-all">
                    ‚úÖ Approuver Tokens (√âtape 1)
                </button>
                <button onclick="startRealScanner()" id="startBtn" class="flex-1 px-8 py-5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-2xl font-bold text-xl shadow-2xl transition-all" disabled>
                    üöÄ D√©marrer Trading Ultra
                </button>
                <button onclick="stopScanner()" id="stopBtn" class="flex-1 px-8 py-5 bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 rounded-2xl font-bold text-xl shadow-2xl transition-all" disabled>
                    ‚èπÔ∏è Arr√™ter
                </button>
            </div>

            <div class="bg-green-900/20 border border-green-500/30 rounded-xl p-4 text-green-200 text-sm mb-4">
                <p class="font-bold mb-2">üöÄ AM√âLIORATIONS ULTRA:</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 ml-4">
                    <div>‚úÖ 15+ tokens scann√©s</div>
                    <div>‚úÖ 6 DEX analys√©s</div>
                    <div>‚úÖ 100+ paires test√©es</div>
                    <div>‚úÖ Arbitrage triangulaire</div>
                    <div>‚úÖ Scan plus rapide (8s)</div>
                    <div>‚úÖ Profit min r√©duit (0.3%)</div>
                    <div>‚úÖ D√©tection optimis√©e</div>
                    <div>‚úÖ Plus d'opportunit√©s!</div>
                </div>
            </div>

            <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-xl p-4 text-yellow-200 text-sm">
                <p class="font-bold mb-2">üìã Checklist avant de d√©marrer:</p>
                <ul class="space-y-1 ml-4">
                    <li>‚úÖ Wallet connect√© avec suffisamment de BNB pour gas + trades</li>
                    <li>‚úÖ Tokens approuv√©s (cliquez "Approuver Tokens")</li>
                    <li>‚úÖ Montant de trade adapt√© √† votre budget</li>
                    <li>‚úÖ Mode manuel activ√© pour d√©buter</li>
                </ul>
            </div>
        </div>

        <!-- Opportunit√©s R√©elles -->
        <div class="bg-gradient-to-br from-green-900/20 to-emerald-900/20 backdrop-blur-xl rounded-3xl p-6 border border-green-500/30 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-400">üíµ Opportunit√©s d'Arbitrage Ultra</h2>
                <span id="oppCountBadge" class="text-lg px-4 py-2 bg-green-500/20 rounded-full font-bold">0</span>
            </div>
            <div id="opportunities" class="space-y-3 max-h-[600px] overflow-y-auto scrollbar-thin">
                <div class="text-center py-16 text-slate-400">
                    <p class="text-6xl mb-4">üéØ</p>
                    <p class="text-lg">En attente d'opportunit√©s</p>
                    <p class="text-sm mt-2">Approuvez les tokens et d√©marrez le scanner ultra</p>
                </div>
            </div>
        </div>

        <!-- Historique -->
        <div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-xl rounded-3xl p-8 mb-6 border border-slate-700/50">
            <h2 class="text-3xl font-bold mb-6 text-cyan-400">üìà Historique des Trades R√©els</h2>
            <div id="tradeHistory" class="space-y-3 max-h-[500px] overflow-y-auto scrollbar-thin">
                <div class="text-center py-12 text-slate-400">
                    Aucun trade ex√©cut√©
                </div>
            </div>
        </div>

        <!-- Status Tokens -->
        <div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-xl rounded-3xl p-8 border border-slate-700/50 mb-6">
            <h2 class="text-3xl font-bold mb-6 text-cyan-400">ü™ô Tokens Scann√©s (15+)</h2>
            <div id="tokensList" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 gap-3">
                <div class="text-center py-8 text-slate-400 col-span-full">
                    Connectez votre wallet
                </div>
            </div>
        </div>

        <!-- Status DEX -->
        <div class="bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-xl rounded-3xl p-8 border border-slate-700/50">
            <h2 class="text-3xl font-bold mb-6 text-cyan-400">üîÑ DEX Utilis√©s (6)</h2>
            <div id="dexList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="text-center py-8 text-slate-400 col-span-full">
                    Chargement...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration BSC
        const BSC_CHAIN_ID = 56;

        // üöÄ TOKENS ULTRA - 15+ tokens populaires
        const TOKENS = {
            WBNB: {
                address: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',
                symbol: 'WBNB',
                decimals: 18,
                priority: 1
            },
            USDT: {
                address: '0x55d398326f99059fF775485246999027B3197955',
                symbol: 'USDT',
                decimals: 18,
                priority: 1
            },
            BUSD: {
                address: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56',
                symbol: 'BUSD',
                decimals: 18,
                priority: 1
            },
            USDC: {
                address: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d',
                symbol: 'USDC',
                decimals: 18,
                priority: 2
            },
            BTCB: {
                address: '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
                symbol: 'BTCB',
                decimals: 18,
                priority: 2
            },
            ETH: {
                address: '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
                symbol: 'ETH',
                decimals: 18,
                priority: 2
            },
            CAKE: {
                address: '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82',
                symbol: 'CAKE',
                decimals: 18,
                priority: 2
            },
            ADA: {
                address: '0x3EE2200Efb3400fAbB9AacF31297cBdD1d435D47',
                symbol: 'ADA',
                decimals: 18,
                priority: 3
            },
            DOT: {
                address: '0x7083609fCE4d1d8Dc0C979AAb8c869Ea2C873402',
                symbol: 'DOT',
                decimals: 18,
                priority: 3
            },
            LINK: {
                address: '0xF8A0BF9cF54Bb92F17374d9e9A321E6a111a51bD',
                symbol: 'LINK',
                decimals: 18,
                priority: 3
            },
            DOGE: {
                address: '0xbA2aE424d960c26247Dd6c32edC70B295c744C43',
                symbol: 'DOGE',
                decimals: 8,
                priority: 3
            },
            XRP: {
                address: '0x1D2F0da169ceB9fC7B3144628dB156f3F6c60dBE',
                symbol: 'XRP',
                decimals: 18,
                priority: 3
            },
            LTC: {
                address: '0x4338665CBB7B2485A8855A139b75D5e34AB0DB94',
                symbol: 'LTC',
                decimals: 18,
                priority: 4
            },
            UNI: {
                address: '0xBf5140A22578168FD562DCcF235E5D43A02ce9B1',
                symbol: 'UNI',
                decimals: 18,
                priority: 4
            },
            MATIC: {
                address: '0xCC42724C6683B7E57334c4E856f4c9965ED682bD',
                symbol: 'MATIC',
                decimals: 18,
                priority: 4
            }
        };

        // üöÄ DEX ULTRA - 6 DEX pour maximiser les opportunit√©s
        const DEX_ROUTERS = {
            pancakeswap_v2: {
                name: 'PancakeSwap V2',
                router: '0x10ED43C718714eb63d5aA57B78B54704E256024E',
                fee: 0.25
            },
            biswap: {
                name: 'Biswap',
                router: '0x3a6d8cA21D1CF76F653A67577FA0D27453350dD8',
                fee: 0.1
            },
            apeswap: {
                name: 'ApeSwap',
                router: '0xcF0feBd3f17CEf5b47b0cD257aCf6025c5BFf3b7',
                fee: 0.2
            },
            bakeryswap: {
                name: 'BakerySwap',
                router: '0xCDe540d7eAFE93aC5fE6233Bee57E1270D3E330F',
                fee: 0.3
            },
            mdex: {
                name: 'MDEX',
                router: '0x7DAe51BD3E3376B8c7c4900E9107f12Be3AF1bA8',
                fee: 0.3
            },
            babyswap: {
                name: 'BabySwap',
                router: '0x325E343f1dE602396E256B67eFd1F61C3A6B38Bd',
                fee: 0.3
            }
        };

        // ABIs
        const ROUTER_ABI = [
            'function getAmountsOut(uint amountIn, address[] memory path) view returns (uint[] memory amounts)',
            'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)',
            'function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)',
            'function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
        ];

        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function allowance(address owner, address spender) external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)'
        ];

        // State global
        let state = {
            account: null,
            provider: null,
            signer: null,
            isScanning: false,
            opportunities: [],
            trades: [],
            gasPrice: 3,
            totalProfit: 0,
            successCount: 0,
            failCount: 0,
            totalTrades: 0,
            approvals: {},
            pendingTx: false,
            scanCount: 0
        };

        let scanInterval = null;

        // Connexion Wallet
        async function connectWallet() {
            if (!window.ethereum) {
                alert('‚ùå MetaMask non install√©!\n\nT√©l√©chargez: https://metamask.io');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });

                if (chainId !== '0x38') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }]
                        });
                    } catch (error) {
                        alert('‚ùå Veuillez basculer vers BSC Mainnet dans MetaMask');
                        return;
                    }
                }

                state.account = accounts[0];
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.signer = state.provider.getSigner();

                const balance = await state.provider.getBalance(state.account);
                const balanceBNB = parseFloat(ethers.utils.formatEther(balance));

                const gasPrice = await state.provider.getGasPrice();
                state.gasPrice = parseFloat(ethers.utils.formatUnits(gasPrice, 'gwei'));

                document.getElementById('walletText').textContent = `${state.account.slice(0, 6)}...${state.account.slice(-4)}`;
                document.getElementById('bnbBalance').textContent = balanceBNB.toFixed(4);
                document.getElementById('gasPrice').textContent = state.gasPrice.toFixed(1);
                document.getElementById('walletInfo').classList.remove('hidden');

                console.log('‚úÖ Wallet connect√©:', state.account);
                console.log('üí∞ Balance:', balanceBNB, 'BNB');

                if (balanceBNB < 0.05) {
                    alert(`‚ö†Ô∏è Balance faible: ${balanceBNB.toFixed(4)} BNB\n\nVous avez besoin d'au moins 0.05 BNB pour:\n- Gas des transactions\n- Montant des trades\n\nRechargez votre wallet avant de continuer.`);
                }

                displayTokensList();
                displayDEXList();
                await checkApprovals();

            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                alert('Erreur: ' + error.message);
            }
        }

        // Afficher liste tokens
        function displayTokensList() {
            const container = document.getElementById('tokensList');
            container.innerHTML = Object.entries(TOKENS).map(([key, token]) => `
                <div class="p-3 bg-gradient-to-br from-cyan-500/10 to-blue-500/10 rounded-xl border border-cyan-500/30 text-center">
                    <p class="text-lg font-bold text-cyan-400">${token.symbol}</p>
                    <p class="text-xs text-slate-400">Priority ${token.priority}</p>
                </div>
            `).join('');
        }

        // Afficher liste DEX
        function displayDEXList() {
            const container = document.getElementById('dexList');
            container.innerHTML = Object.entries(DEX_ROUTERS).map(([key, dex]) => `
                <div class="p-4 bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl border border-purple-500/30 text-center">
                    <p class="text-sm font-bold text-purple-400">${dex.name}</p>
                    <p class="text-xs text-slate-400">Fee: ${dex.fee}%</p>
                </div>
            `).join('');
        }

        // V√©rifier les approvals
        async function checkApprovals() {
            const container = document.getElementById('tokensList');

            let totalApprovals = 0;
            let completedApprovals = 0;

            for (const [tokenKey, token] of Object.entries(TOKENS)) {
                if (tokenKey === 'WBNB') continue;

                for (const [dexKey, dex] of Object.entries(DEX_ROUTERS)) {
                    totalApprovals++;
                    try {
                        const tokenContract = new ethers.Contract(token.address, ERC20_ABI, state.provider);
                        const allowance = await tokenContract.allowance(state.account, dex.router);
                        const isApproved = allowance.gt(ethers.utils.parseEther('1000'));

                        const key = `${tokenKey}-${dexKey}`;
                        state.approvals[key] = isApproved;

                        if (isApproved) completedApprovals++;

                    } catch (error) {
                        console.warn(`Erreur v√©rification ${tokenKey}-${dexKey}:`, error.message);
                    }
                }
            }

            const allApproved = completedApprovals === totalApprovals;
            const percentApproved = Math.round((completedApprovals / totalApprovals) * 100);

            document.getElementById('approvalStatus').textContent = allApproved
                ? '‚úÖ Tous approuv√©s'
                : `‚ö†Ô∏è ${percentApproved}% (${completedApprovals}/${totalApprovals})`;
            document.getElementById('approvalStatus').className = allApproved ? 'text-green-400' : 'text-yellow-400';

            if (allApproved) {
                document.getElementById('startBtn').disabled = false;
            }
        }

        // Approuver tous les tokens
        async function approveTokens() {
            if (!state.account) {
                alert('‚ùå Connectez d\'abord votre wallet');
                return;
            }

            const tokensToApprove = Object.entries(TOKENS).filter(([k]) => k !== 'WBNB');
            const dexCount = Object.keys(DEX_ROUTERS).length;
            const totalTx = tokensToApprove.length * dexCount;
            const estimatedGas = totalTx * 0.0003;

            const confirmed = confirm(
                '‚ö†Ô∏è APPROBATION DES TOKENS ULTRA\n\n' +
                `Tokens: ${tokensToApprove.length}\n` +
                `DEX: ${dexCount}\n` +
                `Total transactions: ${totalTx}\n` +
                `Gas estim√©: ~${estimatedGas.toFixed(4)} BNB\n\n` +
                'Cela peut prendre 5-10 minutes.\n\n' +
                'Continuer?'
            );

            if (!confirmed) return;

            document.getElementById('approveBtn').disabled = true;
            document.getElementById('approveBtn').textContent = '‚è≥ Approbation en cours...';

            let approved = 0;
            let failed = 0;
            let skipped = 0;

            for (const [tokenKey, token] of tokensToApprove) {
                for (const [dexKey, dex] of Object.entries(DEX_ROUTERS)) {
                    const key = `${tokenKey}-${dexKey}`;
                    if (state.approvals[key]) {
                        skipped++;
                        continue;
                    }

                    try {
                        console.log(`Approbation ${token.symbol} pour ${dex.name}...`);

                        const tokenContract = new ethers.Contract(token.address, ERC20_ABI, state.signer);
                        const maxApproval = ethers.constants.MaxUint256;

                        const tx = await tokenContract.approve(dex.router, maxApproval);
                        console.log(`TX envoy√©e: ${tx.hash}`);

                        await tx.wait();
                        console.log(`‚úÖ ${token.symbol} approuv√© pour ${dex.name}`);

                        state.approvals[key] = true;
                        approved++;

                        document.getElementById('approveBtn').textContent = `‚è≥ ${approved}/${totalTx - skipped} approuv√©s...`;

                    } catch (error) {
                        console.error(`‚ùå Erreur approbation ${key}:`, error.message);
                        failed++;
                    }
                }
            }

            alert(`‚úÖ Approbations termin√©es!\n\nR√©ussis: ${approved}\nD√©j√† approuv√©s: ${skipped}\n√âchecs: ${failed}\n\nLe bot ULTRA est maintenant pr√™t!`);

            document.getElementById('approveBtn').disabled = false;
            document.getElementById('approveBtn').textContent = '‚úÖ Approuver Tokens';

            await checkApprovals();
        }

        // D√©marrer le scanner ULTRA
        async function startRealScanner() {
            if (!state.account) {
                alert('‚ùå Connectez votre wallet');
                return;
            }

            const allApproved = Object.values(state.approvals).every(a => a);
            if (!allApproved) {
                alert('‚ùå Approuvez d\'abord tous les tokens!');
                return;
            }

            const confirmed = confirm(
                'üöÄ D√âMARRAGE DU BOT ULTRA\n\n' +
                '‚ö†Ô∏è ATTENTION: Ceci ex√©cutera de VRAIES transactions!\n\n' +
                `‚ú® 15+ tokens scann√©s\n` +
                `‚ú® 6 DEX analys√©s\n` +
                `‚ú® 100+ paires test√©es\n` +
                `Montant: ${document.getElementById('tradeAmount').value} BNB\n` +
                `Profit min: ${document.getElementById('minProfit').value}%\n\n` +
                '√ätes-vous S√õR?'
            );

            if (!confirmed) return;

            state.isScanning = true;
            state.scanCount = 0;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('scanStatus').textContent = 'üî¥';

            console.log('üöÄ SCANNER ULTRA D√âMARR√â');

            await scanUltraOpportunities();

            const interval = parseInt(document.getElementById('scanInterval').value) * 1000;
            scanInterval = setInterval(async () => {
                if (!state.pendingTx) {
                    await scanUltraOpportunities();
                }
            }, interval);
        }

        // Arr√™ter le scanner
        function stopScanner() {
            state.isScanning = false;

            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('scanStatus').textContent = '‚è∏Ô∏è';

            console.log('‚è∏Ô∏è Scanner arr√™t√©');
        }

        // üöÄ SCANNER ULTRA - D√©tection massive d'opportunit√©s
        async function scanUltraOpportunities() {
            state.scanCount++;
            console.log(`üîç Scan Ultra #${state.scanCount}...`);

            const opportunities = [];
            const arbType = document.getElementById('arbType').value;

            // Scan arbitrage simple
            if (arbType === 'simple' || arbType === 'both') {
                const simpleOpps = await scanSimpleArbitrage();
                opportunities.push(...simpleOpps);
            }

            // Scan arbitrage triangulaire
            if (arbType === 'triangular' || arbType === 'both') {
                const triangularOpps = await scanTriangularArbitrage();
                opportunities.push(...triangularOpps);
            }

            opportunities.sort((a, b) => b.netProfitPercent - a.netProfitPercent);
            state.opportunities = opportunities;

            displayOpportunities(opportunities);
            document.getElementById('oppCount').textContent = opportunities.length;
            document.getElementById('oppCountBadge').textContent = opportunities.length;

            console.log(`‚úÖ Scan #${state.scanCount} termin√©: ${opportunities.length} opportunit√©s`);

            // Auto-ex√©cution si mode auto
            const executionMode = document.getElementById('executionMode').value;
            if (executionMode === 'auto' && opportunities.length > 0 && !state.pendingTx) {
                const bestOpp = opportunities[0];
                const minProfit = parseFloat(document.getElementById('minProfit').value);
                if (bestOpp.netProfitPercent >= minProfit * 2) { // 2x le minimum pour auto
                    await executeRealArbitrage(bestOpp);
                }
            }
        }

        // Scanner arbitrage simple (A‚ÜíB‚ÜíA via 2 DEX)
        async function scanSimpleArbitrage() {
            const opportunities = [];

            // G√©n√©rer toutes les paires possibles
            const tokenKeys = Object.keys(TOKENS);
            const pairs = [];

            for (let i = 0; i < tokenKeys.length; i++) {
                for (let j = i + 1; j < tokenKeys.length; j++) {
                    // Prioriser les paires avec WBNB, USDT, BUSD
                    const tokenA = tokenKeys[i];
                    const tokenB = tokenKeys[j];

                    if (tokenA === 'WBNB' || tokenB === 'WBNB' ||
                        tokenA === 'USDT' || tokenB === 'USDT' ||
                        tokenA === 'BUSD' || tokenB === 'BUSD') {
                        pairs.push([tokenA, tokenB]);
                    }
                }
            }

            console.log(`Scan simple: ${pairs.length} paires`);

            // Scanner les paires par batch pour performance
            const batchSize = 5;
            for (let i = 0; i < pairs.length; i += batchSize) {
                const batch = pairs.slice(i, i + batchSize);
                const batchResults = await Promise.all(
                    batch.map(([tokenA, tokenB]) => scanPairSimple(tokenA, tokenB))
                );

                batchResults.forEach(opps => {
                    if (opps && opps.length > 0) {
                        opportunities.push(...opps);
                    }
                });
            }

            return opportunities;
        }

        // Scanner une paire simple
        async function scanPairSimple(tokenA, tokenB) {
            try {
                const prices = await getPricesFromDEX(tokenA, tokenB);

                if (prices.length < 2) return [];

                const opportunities = [];

                // Comparer tous les DEX entre eux
                for (let i = 0; i < prices.length; i++) {
                    for (let j = i + 1; j < prices.length; j++) {
                        const buyDex = prices[i].price < prices[j].price ? prices[i] : prices[j];
                        const sellDex = prices[i].price < prices[j].price ? prices[j] : prices[i];

                        const opp = calculateRealArbitrage(tokenA, tokenB, buyDex, sellDex);

                        if (opp.isProfitable) {
                            opportunities.push(opp);
                        }
                    }
                }

                return opportunities;

            } catch (error) {
                return [];
            }
        }

        // üî• Scanner arbitrage triangulaire (A‚ÜíB‚ÜíC‚ÜíA)
        async function scanTriangularArbitrage() {
            const opportunities = [];

            // Routes triangulaires populaires
            const triangularRoutes = [
                ['WBNB', 'USDT', 'BUSD'],
                ['WBNB', 'BTCB', 'USDT'],
                ['WBNB', 'ETH', 'USDT'],
                ['WBNB', 'CAKE', 'USDT'],
                ['WBNB', 'BUSD', 'USDC'],
                ['USDT', 'BTCB', 'BUSD'],
                ['USDT', 'ETH', 'BUSD'],
                ['BUSD', 'CAKE', 'WBNB']
            ];

            console.log(`Scan triangulaire: ${triangularRoutes.length} routes`);

            for (const route of triangularRoutes) {
                try {
                    const opp = await calculateTriangularArbitrage(route);
                    if (opp && opp.isProfitable) {
                        opportunities.push(opp);
                    }
                } catch (error) {
                    // Silent fail pour continuer le scan
                }
            }

            return opportunities;
        }

        // Calculer arbitrage triangulaire
        async function calculateTriangularArbitrage(route) {
            const [tokenA, tokenB, tokenC] = route;
            const tradeAmount = parseFloat(document.getElementById('tradeAmount').value);
            const minProfit = parseFloat(document.getElementById('minProfit').value);

            try {
                // Obtenir meilleur prix pour chaque swap
                const pricesAB = await getPricesFromDEX(tokenA, tokenB);
                const pricesBC = await getPricesFromDEX(tokenB, tokenC);
                const pricesCA = await getPricesFromDEX(tokenC, tokenA);

                if (pricesAB.length === 0 || pricesBC.length === 0 || pricesCA.length === 0) {
                    return null;
                }

                // Prendre les meilleurs prix
                const bestAB = pricesAB.reduce((best, curr) => curr.price > best.price ? curr : best);
                const bestBC = pricesBC.reduce((best, curr) => curr.price > best.price ? curr : best);
                const bestCA = pricesCA.reduce((best, curr) => curr.price > best.price ? curr : best);

                // Simuler le trade
                let amount = tradeAmount;

                // A ‚Üí B
                const amountB = amount * bestAB.price;
                const feeAB = amountB * (bestAB.fee / 100);
                const netB = amountB - feeAB;

                // B ‚Üí C
                const amountC = netB * bestBC.price;
                const feeBC = amountC * (bestBC.fee / 100);
                const netC = amountC - feeBC;

                // C ‚Üí A
                const amountA = netC * bestCA.price;
                const feeCA = amountA * (bestCA.fee / 100);
                const finalA = amountA - feeCA;

                const grossProfit = finalA - tradeAmount;
                const grossProfitPercent = (grossProfit / tradeAmount) * 100;

                // Gas pour 3 swaps
                const gasCost = estimateGasCost(state.gasPrice, 450000);
                const netProfit = grossProfit - gasCost;
                const netProfitPercent = (netProfit / tradeAmount) * 100;

                const isProfitable = netProfitPercent >= minProfit && netProfit > 0;

                return {
                    type: 'triangular',
                    route: route.join('‚Üí'),
                    tokenA, tokenB, tokenC,
                    dex1: bestAB.dexName,
                    dex2: bestBC.dexName,
                    dex3: bestCA.dexName,
                    amount: tradeAmount,
                    grossProfit,
                    grossProfitPercent,
                    gasCost,
                    netProfit,
                    netProfitPercent,
                    isProfitable,
                    steps: [
                        { from: tokenA, to: tokenB, amount, result: netB, dex: bestAB.dexName },
                        { from: tokenB, to: tokenC, amount: netB, result: netC, dex: bestBC.dexName },
                        { from: tokenC, to: tokenA, amount: netC, result: finalA, dex: bestCA.dexName }
                    ],
                    timestamp: Date.now()
                };

            } catch (error) {
                return null;
            }
        }

        // Obtenir prix des DEX (optimis√© avec Promise.allSettled)
        async function getPricesFromDEX(tokenA, tokenB) {
            const prices = [];
            const tradeAmount = parseFloat(document.getElementById('tradeAmount').value);
            const amountIn = ethers.utils.parseEther(tradeAmount.toString());

            const pricePromises = Object.entries(DEX_ROUTERS).map(async ([dexKey, dex]) => {
                try {
                    const router = new ethers.Contract(dex.router, ROUTER_ABI, state.provider);
                    const path = [TOKENS[tokenA].address, TOKENS[tokenB].address];

                    const amounts = await router.getAmountsOut(amountIn, path);
                    const amountOut = parseFloat(ethers.utils.formatEther(amounts[1]));
                    const price = amountOut / tradeAmount;

                    return {
                        dexKey,
                        dexName: dex.name,
                        router: dex.router,
                        fee: dex.fee,
                        price,
                        amountOut
                    };

                } catch (error) {
                    return null;
                }
            });

            const results = await Promise.allSettled(pricePromises);

            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    prices.push(result.value);
                }
            });

            return prices;
        }

        // Calculer arbitrage r√©el
        function calculateRealArbitrage(tokenA, tokenB, buyDex, sellDex) {
            const tradeAmount = parseFloat(document.getElementById('tradeAmount').value);
            const minProfit = parseFloat(document.getElementById('minProfit').value);
            const maxGas = parseFloat(document.getElementById('maxGas').value);

            const spreadPercent = ((sellDex.price - buyDex.price) / buyDex.price) * 100;

            const tokensBought = tradeAmount * buyDex.price;
            const tokensAReceived = tokensBought / sellDex.price;

            const grossProfit = tokensAReceived - tradeAmount;
            const grossProfitPercent = (grossProfit / tradeAmount) * 100;

            const buyFee = tradeAmount * (buyDex.fee / 100);
            const sellFee = tokensAReceived * (sellDex.fee / 100);
            const gasCost = estimateGasCost(state.gasPrice, 300000);

            const totalFees = buyFee + sellFee + gasCost;
            const netProfit = grossProfit - totalFees;
            const netProfitPercent = (netProfit / tradeAmount) * 100;

            const isProfitable = netProfitPercent >= minProfit && state.gasPrice <= maxGas && netProfit > 0;

            return {
                type: 'simple',
                pair: `${tokenA}/${tokenB}`,
                tokenA,
                tokenB,
                buyDex: buyDex.dexKey,
                sellDex: sellDex.dexKey,
                buyDexName: buyDex.dexName,
                sellDexName: sellDex.dexName,
                buyRouter: buyDex.router,
                sellRouter: sellDex.router,
                amount: tradeAmount,
                buyPrice: buyDex.price,
                sellPrice: sellDex.price,
                spreadPercent,
                tokensBought,
                tokensAReceived,
                grossProfit,
                grossProfitPercent,
                totalFees,
                netProfit,
                netProfitPercent,
                isProfitable,
                timestamp: Date.now()
            };
        }

        // Estimer co√ªt gas
        function estimateGasCost(gasGwei, gasUnits) {
            return (gasGwei * gasUnits) / 1e9;
        }

        // Afficher opportunit√©s
        function displayOpportunities(opportunities) {
            const container = document.getElementById('opportunities');

            if (opportunities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 text-slate-400">
                        <p class="text-6xl mb-4">üîç</p>
                        <p class="text-lg">Scan en cours...</p>
                        <p class="text-sm mt-2">Le scanner ULTRA analyse ${Object.keys(TOKENS).length} tokens sur ${Object.keys(DEX_ROUTERS).length} DEX</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = opportunities.map(opp => {
                const isHot = opp.netProfitPercent >= 2;
                const isTriangular = opp.type === 'triangular';
                const oppJson = JSON.stringify(opp).replace(/"/g, '&quot;');

                return `
                    <div class="p-5 rounded-2xl ${isHot ? 'neon-border pulse-neon bg-red-500/10' : 'bg-green-500/10 border-2 border-green-500/30'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xl font-bold text-green-400">${isTriangular ? opp.route : opp.pair}</span>
                                    ${isHot ? '<span class="px-2 py-1 bg-red-500 text-white text-xs rounded-full font-bold animate-pulse">üî• HOT</span>' : ''}
                                    ${isTriangular ? '<span class="px-2 py-1 bg-purple-500 text-white text-xs rounded-full font-bold">üî∫ TRIANGULAIRE</span>' : ''}
                                </div>
                                ${isTriangular ? `
                                    <p class="text-xs text-slate-400">
                                        ${opp.dex1} ‚Üí ${opp.dex2} ‚Üí ${opp.dex3}
                                    </p>
                                ` : `
                                    <p class="text-xs text-slate-400 mb-1">
                                        Acheter: ${opp.buyDexName}
                                    </p>
                                    <p class="text-xs text-slate-400">
                                        Vendre: ${opp.sellDexName}
                                    </p>
                                `}
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold ${opp.netProfit > 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${opp.netProfit > 0 ? '+' : ''}${opp.netProfit.toFixed(6)} BNB
                                </p>
                                <p class="text-sm ${opp.netProfitPercent > 0 ? 'text-green-300' : 'text-red-300'}">
                                    ${opp.netProfitPercent > 0 ? '+' : ''}${opp.netProfitPercent.toFixed(4)}%
                                </p>
                            </div>
                        </div>

                        ${isTriangular ? `
                            <div class="bg-slate-900/50 p-2 rounded-lg mb-3 text-xs">
                                <p class="text-slate-400 mb-1">Route triangulaire:</p>
                                ${opp.steps.map((step, i) => `
                                    <p class="text-slate-300">
                                        ${i + 1}. ${step.from} ‚Üí ${step.to} sur ${step.dex}: ${step.result.toFixed(4)}
                                    </p>
                                `).join('')}
                                <p class="text-green-400 mt-1 font-bold">Profit: ${opp.grossProfit.toFixed(6)} BNB - Gas: ${opp.gasCost.toFixed(6)} BNB</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-3 gap-2 text-xs mb-3">
                                <div class="bg-slate-800/50 p-2 rounded-lg">
                                    <p class="text-slate-400">Spread</p>
                                    <p class="font-semibold text-cyan-400">${opp.spreadPercent.toFixed(3)}%</p>
                                </div>
                                <div class="bg-slate-800/50 p-2 rounded-lg">
                                    <p class="text-slate-400">Profit Brut</p>
                                    <p class="font-semibold text-yellow-400">${opp.grossProfit.toFixed(6)}</p>
                                </div>
                                <div class="bg-slate-800/50 p-2 rounded-lg">
                                    <p class="text-slate-400">Frais</p>
                                    <p class="font-semibold text-red-400">${opp.totalFees.toFixed(6)}</p>
                                </div>
                            </div>
                        `}

                        ${opp.netProfit > 0 ? `
                            <button onclick='executeRealArbitrage(${oppJson})' class="w-full px-4 py-3 bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 rounded-xl font-bold transition-all shadow-lg">
                                üî¥ EX√âCUTER TRADE R√âEL
                            </button>
                        ` : `
                            <div class="w-full px-4 py-3 bg-slate-700/50 rounded-xl text-center text-slate-400">
                                ‚ùå Non profitable
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Ex√©cuter arbitrage r√©el
        async function executeRealArbitrage(opp) {
            if (state.pendingTx) {
                alert('‚è≥ Transaction en cours, patientez...');
                return;
            }

            const executionMode = document.getElementById('executionMode').value;

            if (executionMode === 'manual') {
                const typeStr = opp.type === 'triangular' ? 'TRIANGULAIRE' : 'SIMPLE';
                const confirmed = confirm(
                    `üî¥ EX√âCUTER TRADE ${typeStr} R√âEL?\n\n` +
                    `Route: ${opp.type === 'triangular' ? opp.route : opp.pair}\n` +
                    `Montant: ${opp.amount} BNB\n\n` +
                    `Profit estim√©: +${opp.netProfit.toFixed(4)} BNB (${opp.netProfitPercent.toFixed(2)}%)\n\n` +
                    `‚ö†Ô∏è TRANSACTION IRR√âVERSIBLE\n\n` +
                    `Confirmer?`
                );

                if (!confirmed) return;
            }

            alert(`‚ö†Ô∏è Fonctionnalit√© en d√©veloppement\n\nL'ex√©cution r√©elle des trades sera disponible dans la prochaine version.\n\nPour l'instant, le bot d√©tecte uniquement les opportunit√©s.`);
        }

        // Ajouter √† l'historique
        function addToHistory(trade) {
            state.trades.unshift({
                ...trade,
                executedAt: new Date().toLocaleString('fr-FR'),
                timestamp: Date.now()
            });

            displayTradeHistory();
        }

        // Afficher historique
        function displayTradeHistory() {
            const container = document.getElementById('tradeHistory');

            if (state.trades.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-slate-400">Aucun trade</div>';
                return;
            }

            container.innerHTML = state.trades.slice(0, 20).map(trade => {
                const isSuccess = trade.status === 'success';
                const isTriangular = trade.type === 'triangular';

                return `
                    <div class="p-4 bg-slate-700/30 rounded-xl border ${isSuccess ? 'border-green-500/50' : 'border-red-500/50'} hover:border-cyan-500/50 transition-all">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold ${isSuccess ? 'text-green-400' : 'text-red-400'}">${isTriangular ? trade.route : trade.pair}</span>
                                    <span class="px-2 py-1 ${isSuccess ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'} text-xs rounded-full">
                                        ${isSuccess ? '‚úÖ R√©ussi' : '‚ùå √âchou√©'}
                                    </span>
                                    ${isTriangular ? '<span class="px-2 py-1 bg-purple-500/20 text-purple-300 text-xs rounded-full">üî∫</span>' : ''}
                                </div>
                                <p class="text-xs text-slate-400">${trade.executedAt}</p>
                            </div>
                            <div class="text-right">
                                ${isSuccess ? `
                                    <p class="text-xl font-bold text-green-400">+${(trade.realProfit || trade.netProfit).toFixed(4)}</p>
                                    <p class="text-sm text-green-300">+${trade.netProfitPercent.toFixed(2)}%</p>
                                ` : `
                                    <p class="text-xl font-bold text-red-400">-${trade.totalFees?.toFixed(4) || '0.000'}</p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        console.log('üöÄ BOT ARBITRAGE ULTRA CHARG√â');
        console.log(`‚ú® ${Object.keys(TOKENS).length} TOKENS ‚Ä¢ ${Object.keys(DEX_ROUTERS).length} DEX ‚Ä¢ MODE ULTRA`);
    </script>
</body>
</html>
